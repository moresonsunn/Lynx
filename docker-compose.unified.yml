# All-in-one single image using controller-unified.Dockerfile (includes Java runtimes)
# Build & run:
#   docker compose -f docker-compose.unified.yml up -d --build

services:
  lynx:
    image: moresonsun/lynx:latest
    build:
      context: .
      dockerfile: docker/controller.Dockerfile
      args:
        - APP_VERSION=${BLOCKPANEL_TAG:-dev}
    ports:
      - "8000:8000"
    environment:
      - APP_NAME=Lynx
      - APP_VERSION=latest
      - USE_POSTGRES=false
      - DATABASE_URL=sqlite:////data/sqlite/minecraft_controller.db
      - SERVERS_CONTAINER_ROOT=/data/servers
      # Must match the actual Docker named volume created by compose: <project>_servers_data
      - SERVERS_VOLUME_NAME=minecraft-controller_servers_data
      - BLOCKPANEL_RUNTIME_IMAGE=moresonsun/lynx
      - BLOCKPANEL_RUNTIME_TAG=latest
      - DOCKER_HOST=unix:///var/run/docker.sock
      - ENVIRONMENT=production
      - SECRET_KEY=${SECRET_KEY:-change-me-single-container-secret}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
      # Prefer regex-based CORS to accommodate CasaOS and dev hosts without quotes parsing issues
      - ALLOWED_ORIGIN_REGEX=.*
      # Temporary debug endpoint enabling /debug/echo-headers (remove or set 0 in production)
      - ENABLE_DEBUG_ENDPOINTS=1
      # Optional override; when running under CasaOS this is auto-detected from container labels.
      - CASAOS_APP_ID=${CASAOS_APP_ID:-}
      # CasaOS v2 compose apps (Steam servers)
      - CASAOS_API_BASE=${CASAOS_API_BASE:-}
      - CASAOS_API_TOKEN=${CASAOS_API_TOKEN:-}
      # Optional: run Steam servers on a separate Docker engine so CasaOS can't list them
      - STEAM_DOCKER_HOST=${STEAM_DOCKER_HOST:-}
    volumes:
      - servers_data:/data/servers
      - sqlite_data:/data/sqlite
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/quick"]
      interval: 30s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    labels:
      io.casaos.app: "lynx"
      io.casaos.managed: "true"
      io.casaos.category: "Games"

volumes:
  servers_data:
  sqlite_data:

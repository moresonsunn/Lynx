# Default compose file for Lynx unified deployment
# Build & run:
#   docker compose up -d --build

services:
  lynx:
    image: moresonsun/lynx:latest
    build:
      context: .
      dockerfile: docker/controller-unified.Dockerfile
      args:
        - APP_VERSION=${BLOCKPANEL_TAG:-dev}
    ports:
      - "8000:8000"
    environment:
      - APP_NAME=Lynx
      - APP_VERSION=latest
      - USE_POSTGRES=false
      - DATABASE_URL=sqlite:////data/sqlite/minecraft_controller.db
      - SERVERS_CONTAINER_ROOT=/data/servers
      - SERVERS_VOLUME_NAME=minecraft-controller_servers_data
      - BLOCKPANEL_RUNTIME_IMAGE=moresonsun/lynx
      - BLOCKPANEL_RUNTIME_TAG=latest
      - DOCKER_HOST=unix:///var/run/docker.sock
      - ENVIRONMENT=production
      - SECRET_KEY=${SECRET_KEY:-change-me-single-container-secret}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ADMIN_PASSWORD=admin123
      - ALLOWED_ORIGIN_REGEX=.*
      - ENABLE_DEBUG_ENDPOINTS=1
      - CASAOS_APP_ID=lynx
      # CasaOS v2 compose apps (Steam servers)
      - CASAOS_API_BASE=${CASAOS_API_BASE:-}
      - CASAOS_API_TOKEN=${CASAOS_API_TOKEN:-}
    volumes:
      - servers_data:/data/servers
      - sqlite_data:/data/sqlite
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/quick"]
      interval: 30s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    labels:
      io.casaos.app: "lynx"
      io.casaos.managed: "true"
      io.casaos.category: "Game Servers"

volumes:
  servers_data:
  sqlite_data:
